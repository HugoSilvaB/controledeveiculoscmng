<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Viagens - Câmara Novo Gama</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Cards: transição limitada para evitar reflows/tremores */
        .card-ocorrencia {
            transition: transform .18s ease, box-shadow .18s ease;
            border-left: 6px solid;
        }
        .card-ocorrencia:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .border-perigo { border-left-color: #dc3545 !important; }
        .border-sucesso { border-left-color: #198754 !important; }

        /* Estilo para as miniaturas das fotos */
        .img-miniatura {
            height: 80px;
            width: 100%;
            object-fit: cover;
            cursor: pointer;
            border-radius: 6px;
            transition: filter .18s ease-in-out;
            border: 1px solid #ddd;
        }
        .img-miniatura:hover { filter: brightness(0.8); }

        .modal-body img { max-width: 100%; height: auto; display:block; margin: 0 auto; }

        /* Estabilização do Modal */
        body.modal-open .card-ocorrencia {
            transition: none !important;
            transform: none !important;
        }
        
        .modal-content {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .btn-download-modal {
            background-color: #198754;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-download-modal:hover {
            background-color: #157347;
            color: white;
        }
    </style>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal-fix.css') }}">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-dark"><i class="bi bi-journal-text text-primary"></i> Monitoramento de Viagens</h2>
            <a href="{{ url_for('index') }}" class="btn btn-secondary shadow-sm">
                <i class="bi bi-house-door"></i> Voltar ao Painel
            </a>
        </div>

        {% if not ocorrencias %}
            <div class="alert alert-info text-center shadow-sm">
                <i class="bi bi-info-circle fs-4 d-block mb-2"></i>
                Nenhuma viagem finalizada encontrada.
            </div>
        {% else %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for oco in ocorrencias %}

                <div class="col">
                    {% set tem_texto = oco.observacoes and oco.observacoes.strip() != "" %}
                    {% set tem_fotos = oco.fotos_ocorrencia_multiplas|length > 0 %}
                    {% set tem_problema = tem_texto or tem_fotos %}

                    <div class="card h-100 shadow-sm card-ocorrencia border-0 {{ 'border-perigo' if tem_problema else 'border-sucesso' }}">
                        <div class="card-header bg-white border-0 pt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge {{ 'bg-danger' if tem_problema else 'bg-success' }} mb-2">
                                    <i class="bi bi-calendar3"></i> {{ oco.data_hora_chegada.strftime('%d/%m/%Y %H:%M') }}
                                </span>
                                {% if not tem_problema %}
                                    <span class="text-success small fw-bold"><i class="bi bi-shield-check"></i> LIMPO</span>
                                {% else %}
                                    <span class="text-danger small fw-bold"><i class="bi bi-exclamation-triangle"></i> ALERTA</span>
                                {% endif %}
                            </div>
                            <h5 class="card-title fw-bold mb-0 text-dark">{{ oco.veiculo.modelo }}</h5>
                            <small class="text-muted text-uppercase fw-semibold">Motorista: {{ oco.motorista_nome }}</small>
                        </div>

                        <div class="card-body">
                            {% if tem_problema %}
                                {% if tem_texto %}
                                    <p class="card-text bg-danger-subtle p-3 rounded small border border-danger-subtle mb-3">
                                        <strong class="text-danger"><i class="bi bi-chat-left-text"></i> Relato:</strong><br>
                                        {{ oco.observacoes }}
                                    </p>
                                {% endif %}

                                {% if tem_fotos %}
                                    <label class="form-label small fw-bold text-danger text-uppercase mb-2">
                                        <i class="bi bi-camera"></i> Evidências ({{ oco.fotos_ocorrencia_multiplas|length }}):
                                    </label>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for foto in oco.fotos_ocorrencia_multiplas %}
                                            <div style="width: 80px; height: 80px;">
                                                <img src="{{ url_for('uploaded_file', filename=foto.caminho_foto) }}"
                                                     class="img-fluid rounded border shadow-sm w-100 h-100 img-miniatura"
                                                     style="object-fit: cover;"
                                                     data-bs-toggle="modal" 
                                                     data-bs-target="#modalFoto{{ foto.id }}" 
                                                     alt="Evidência {{ foto.id }}">
                                            </div>

                                            <div class="modal fade" id="modalFoto{{ foto.id }}" tabindex="-1" aria-hidden="true">
                                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                                    <div class="modal-content bg-dark border-0">
                                                        <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-center">
                                                            <h6 class="text-white-50 m-0">Evidência #{{ foto.id }}</h6>
                                                            <div class="d-flex gap-2">
                                                                <a href="{{ url_for('download_file', filename=foto.caminho_foto) }}"
                                                                   class="btn-download-modal shadow-sm">
                                                                    <i class="bi bi-download"></i> Baixar
                                                                </a>
                                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                                            </div>
                                                        </div>
                                                        <div class="modal-body p-2 text-center">
                                                            <img src="{{ url_for('uploaded_file', filename=foto.caminho_foto) }}" class="img-fluid rounded" alt="Evidência ampliada">
                                                            <div class="mt-3 pt-2 border-top border-secondary">
                                                                <a class="text-info text-decoration-none small" href="{{ url_for('uploaded_file', filename=foto.caminho_foto) }}" target="_blank">
                                                                    <i class="bi bi-box-arrow-up-right"></i> Abrir imagem original em nova aba
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-4 bg-success-subtle rounded border border-success-subtle">
                                    <i class="bi bi-check-circle-fill text-success fs-1 opacity-50"></i>
                                    <p class="text-success mb-0 mt-2 fw-bold">Viagem sem intercorrências</p>
                                </div>
                            {% endif %}
                        </div>

                        <div class="card-footer bg-white border-0 pb-3">
                            <hr class="mt-0 opacity-10">
                            <small class="text-muted d-block"><i class="bi bi-building"></i> {{ oco.gabinete_vereador }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="{{ url_for('static', filename='js/modal-fix.js') }}"></script>
</body>
</html>